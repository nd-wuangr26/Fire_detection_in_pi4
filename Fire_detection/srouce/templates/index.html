<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Nh·∫≠n Di·ªán ƒê√°m Ch√°y</title>

    <!-- Bootstrap & Chart.js -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: #f8f9fa; }
        .container { margin-top: 30px; }
        .video-container { text-align: center; padding: 10px; }
        .table-container { height: 400px; overflow-y: auto; }
        h1 { color: #dc3545; }
    </style>
</head>
<body>

<div class="container">
    <div class="row">
        <!-- C·ªôt tr√°i: B·∫£ng l·ªãch s·ª≠ nh·∫≠n di·ªán -->
        <div class="col-md-6">
            <h1 class="text-center">üìú L·ªãch S·ª≠ Nh·∫≠n Di·ªán ƒê√°m Ch√°y</h1>
            <div class="table-container">
                <table class="table table-striped table-bordered">
                    <thead class="table-danger">
                        <tr>
                            <th>STT</th>
                            <th>Th·ªùi gian</th>
                            <th>N·ªôi dung</th>
                        </tr>
                    </thead>
                    <tbody id="fire-log-table">
                        {% for record in data %}
                        <tr>
                            <td>{{ record[0] }}</td>
                            <td>{{ record[1] }}</td>
                            <td>{{ record[2] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- C·ªôt ph·∫£i: H√¨nh ·∫£nh nh·∫≠n di·ªán -->
        <div class="col-md-6">
            <h1 class="text-center">üî• H√¨nh ·∫¢nh Nh·∫≠n Di·ªán</h1>
            <div class="video-container">
                <img src="/esp_feed" class="img-fluid border border-primary" width="100%" alt="ESP32-CAM Stream">
            </div>
        </div>
    </div>

    <!-- Bi·ªÉu ƒë·ªì nh·∫≠n di·ªán ƒë√°m ch√°y -->
    <div class="row mt-4">
        <div class="col-md-12">
            <h1 class="text-center">üìä Bi·ªÉu ƒê·ªì Nh·∫≠n Di·ªán ƒê√°m Ch√°y</h1>
            <canvas id="fireChart"></canvas>
        </div>
    </div>
</div>

<!-- Bootstrap Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // üìå C·∫≠p nh·∫≠t b·∫£ng l·ªãch s·ª≠ nh·∫≠n di·ªán ƒë√°m ch√°y t·ª´ API `/get_fire_detection`
    let fireChart;

    function fetchChartData() {
        fetch('/get_chart_data')
        .then(response => response.json())
        .then(data => {
            console.log("üî• D·ªØ li·ªáu API tr·∫£ v·ªÅ:", data);  // üìå Debug d·ªØ li·ªáu t·ª´ API

            const ctx = document.getElementById('fireChart').getContext('2d');
            if (!ctx) {
                console.error("‚ùå Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ canvas v·ªõi ID 'fireChart'");
                return;
            }

            if (!data.timestamps || !data.counts || data.timestamps.length === 0) {
                console.warn("‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì.");
                return;
            }

            if (fireChart) {
                fireChart.data.labels = data.timestamps;
                fireChart.data.datasets[0].data = data.counts;
                fireChart.update();
            } else {
                fireChart = new Chart(ctx, {
                    type: 'bar',  // üìä Chuy·ªÉn sang bi·ªÉu ƒë·ªì c·ªôt
                    data: {
                        labels: data.timestamps,  // Tr·ª•c X: Gi·ªù nh·∫≠n di·ªán
                        datasets: [{
                            label: 'S·ªë l·∫ßn nh·∫≠n di·ªán ƒë√°m ch√°y m·ªói gi·ªù',
                            data: data.counts,
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            borderColor: 'red',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { 
                                title: { display: true, text: 'Th·ªùi gian (Ng√†y & Gi·ªù)' },
                                type: 'category',
                                ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 }
                            },
                            y: { 
                                title: { display: true, text: 'L·∫ßn nh·∫≠n di·ªán' },
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        })
        .catch(error => console.error('‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu bi·ªÉu ƒë·ªì:', error));
    }

    // ‚è≥ C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì m·ªói gi·ªù (3600000ms)
    setInterval(fetchChartData, 3600000);
    fetchChartData();
</script>

<script>
    function fetchFireLogs() {
        fetch('/get_fire_detection')
        .then(response => response.json())
        .then(data => {
            let tableBody = document.getElementById("fire-log-table");
            tableBody.innerHTML = "";  // X√≥a n·ªôi dung c≈©

            data.forEach((record) => {
                let row = `<tr>
                    <td>${record[0]}</td>  <!-- STT -->
                    <td>${record[1]}</td>  <!-- Th·ªùi gian -->
                    <td>${record[2]}</td>  <!-- N·ªôi dung -->
                </tr>`;
                tableBody.innerHTML += row;
            });
        })
        .catch(error => console.error('‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu:', error));
    }

    // ‚è≥ C·∫≠p nh·∫≠t b·∫£ng m·ªói 3 gi√¢y
    setInterval(fetchFireLogs, 3000);
    fetchFireLogs();
</script>

</body>
</html>
